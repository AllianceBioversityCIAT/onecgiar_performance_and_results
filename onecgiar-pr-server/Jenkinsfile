pipeline {
    agent any

    tools {
        nodejs "Node 20"
    }

    stages {
        stage('Start') {
            steps {
                slackSend (
                    color: '#FFFF00',
                    message: "Reporting *DEV* CI/CD started",
                    channel: "#platform-notifications",
                    tokenCredentialId: 'slack-token',
                    botUser: true,
                    attachments: [
                        [
                            title: "CI/CD Start Details",
                            color: "#FFFF00",
                            fields: [
                                [ title: "Stage", value: "Start", short: true ],
                                [ title: "Job", value: "${env.JOB_NAME}", short: true ],
                                [ title: "Build Number", value: "${env.BUILD_NUMBER}", short: true ]
                            ]
                        ]
                    ]
                )
            }
        }

        stage('Cloning Git') {
            when {
                anyOf {
                    branch 'setup-jenkins'
                    branch 'origin/setup-jenkins'
                }
            }
            steps {
                git branch: 'dev', url: 'https://github.com/AllianceBioversityCIAT/onecgiar_pr'
            }
        }

        stage('Install dependencies') {
            steps {
                dir('onecgiar-pr-server') {
                    sh 'npm install'
                }
                dir('onecgiar-pr-client') {
                    sh 'npm install --force'
                }
            }
        }

        stage('Test') {
            steps {
                script {
                    try {
                        dir('onecgiar-pr-server') {
                            sh 'npm test'
                        }
                    } catch (Exception e) {
                        env.BUILD_EXCEPTION = "Stage: ${env.STAGE_NAME}, Error: ${e.message}"
                        throw e // rethrow the exception to fail the build
                    }
                }
            }
        }

        stage('linting') {
            steps {
                script {
                    try {
                        dir('onecgiar-pr-server') {
                            sh 'npm run lint || exit 1'
                        }
                    } catch (Exception e) {
                        env.BUILD_EXCEPTION = "Stage: ${env.STAGE_NAME}, Error: ${e.message}"
                        error("Linting failed") // This will mark the build as FAILURE and throw an exception
                    }
                }
            }
        }

        stage('Deploy Dev server') {
            steps {
                script {
                    remote = [:]
                    remote.allowAnyHosts = true
                    remote.failOnError = true

                    // Connect to onpremise server
                    withCredentials([
                        usernamePassword(credentialsId: 'prms-development', usernameVariable: 'username', passwordVariable: 'password'),
                        string(credentialsId: 'prms_server_test', variable: 'server_host'),
                        string(credentialsId: 'prms_name_test', variable: 'remote_name')
                    ]) {
                        remote.user = username
                        remote.password = password
                        remote.host = server_host
                        remote.name = remote_name
                        sshCommand remote: remote, command: "bash /opt/projects/scripts/upPr.sh"
                    }
                }
            }
        }
    }

    post {
        success {
            slackSend (
                color: '#00FF00',
                message: "Reporting *DEV* CI/CD succeeded",
                channel: "#platform-notifications",
                tokenCredentialId: 'slack-token',
                botUser: true,
                attachments: [
                    [
                        title: "CI/CD Success Details",
                        color: "#00FF00",
                        fields: [
                            [ title: "Stage", value: "${env.STAGE_NAME}", short: true ],
                            [ title: "Job", value: "${env.JOB_NAME}", short: true ],
                            [ title: "Build Number", value: "${env.BUILD_NUMBER}", short: true ]
                        ]
                    ]
                ]
            )
        }
        failure {
            script {
                slackSend (
                    color: '#FF0000',
                    message: "Reporting *DEV* CI/CD failed: ${env.BUILD_EXCEPTION}",
                    channel: "#platform-notifications",
                    tokenCredentialId: 'slack-token',
                    botUser: true,
                    attachments: [
                        [
                            title: "Build Failure Details",
                            color: "#FF0000",
                            fields: [
                                [ title: "Stage", value: "${env.STAGE_NAME}", short: true ],
                                [ title: "Job", value: "${env.JOB_NAME}", short: true ],
                                [ title: "Build Number", value: "${env.BUILD_NUMBER}", short: true ]
                            ]
                        ]
                    ]
                )
            }
        }
    }
}